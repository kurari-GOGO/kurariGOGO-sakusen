<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Raid Strat Whiteboard</title>
    <style>
      html, body {
        margin: 0;
        background: #0b0b0f;
        color: #fff;
        font-family: ui-sans-serif, system-ui, -apple-system;
      }
      .container {
        max-width: 1000px;
        margin: auto;
        padding: 16px;
      }
      .panel {
        width: 280px;
        float: left;
        margin-right: 16px;
      }
      .canvas {
        width: calc(100% - 320px);
        height: 700px;
        background: #111;
        border-radius: 12px;
        border: 1px solid #333;
      }
      button {
        margin: 4px;
        padding: 6px 10px;
        border-radius: 6px;
        background: #222;
        color: #fff;
        border: 1px solid #555;
        cursor: pointer;
      }
      button.active {
        background: #666;
      }
      .color-sample {
        display: inline-block;
        width: 18px;
        height: 18px;
        border-radius: 4px;
        margin-right: 6px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="panel">
        <h2>Raid Strat Whiteboard</h2>
        <div id="palette"></div>
        <p>
          <button id="pen">ペン</button>
          <button id="arrow">矢印</button>
          <button id="circle">円</button>
          <button id="clear">クリア</button>
        </p>
      </div>
      <canvas id="board" class="canvas"></canvas>
    </div>

    <!-- CDN scripts -->
    <script src="https://cdn.jsdelivr.net/npm/konva@9.0.0/konva.min.js"></script>
    <script>
      const stage = new Konva.Stage({
        container: 'board',
        width: window.innerWidth - 350,
        height: 700,
      });
      const layer = new Konva.Layer();
      stage.add(layer);

      // Palette
      const palette = [
        { label: 'タンク', color: '#ff6b6b' },
        { label: '近接DPS', color: '#feca57' },
        { label: 'キャスターDPS', color: '#5f27cd' },
        { label: 'ピュアヒーラー', color: '#48dbfb' },
        { label: 'バリアヒーラー', color: '#1dd1a1' },
        { label: 'BOSS', color: '#ffffff' },
        { label: '雑魚', color: '#c0c0c0' },
      ];

      const paletteDiv = document.getElementById('palette');
      palette.forEach(p => {
        const btn = document.createElement('button');
        btn.innerHTML = `<span class="color-sample" style="background:${p.color}"></span>${p.label}`;
        btn.onclick = () => addCircle(p.color, p.label);
        paletteDiv.appendChild(btn);
      });

      // Drawing setup
      let isDrawing = false;
      let currentLine;
      let mode = 'pen';

      document.getElementById('pen').onclick = () => (mode = 'pen');
      document.getElementById('arrow').onclick = () => (mode = 'arrow');
      document.getElementById('circle').onclick = () => (mode = 'circle');
      document.getElementById('clear').onclick = () => {
        layer.destroyChildren();
        layer.draw();
      };

      function addCircle(color, label) {
        const c = new Konva.Circle({
          x: 100 + Math.random() * 400,
          y: 100 + Math.random() * 400,
          radius: 22,
          fill: color,
          stroke: '#333',
          strokeWidth: 2,
          draggable: true,
        });
        const t = new Konva.Text({
          text: label,
          fontSize: 12,
          fill: '#000',
          align: 'center',
          width: 44,
          offsetX: 22,
          offsetY: -6,
        });
        const g = new Konva.Group({ draggable: true });
        g.add(c);
        g.add(t);
        layer.add(g);
        layer.draw();
      }

      // Pen mode
      stage.on('mousedown touchstart', () => {
        if (mode !== 'pen') return;
        isDrawing = true;
        const pos = stage.getPointerPosition();
        currentLine = new Konva.Line({
          stroke: '#fff',
          strokeWidth: 2,
          globalCompositeOperation: 'source-over',
          points: [pos.x, pos.y],
        });
        layer.add(currentLine);
      });

      stage.on('mouseup touchend', () => {
        isDrawing = false;
      });

      stage.on('mousemove touchmove', () => {
        if (!isDrawing || mode !== 'pen') return;
        const pos = stage.getPointerPosition();
        const newPoints = currentLine.points().concat([pos.x, pos.y]);
        currentLine.points(newPoints);
        layer.batchDraw();
      });
    </script>
  </body>
</html>
